<dataConfig>
    <dataSource driver="com.mysql.jdbc.Driver" url="jdbc:mysql://127.0.0.1/dop" user="root" password="root" readOnly="true" />
    <document>
        <!--
            Primary key (uniqueKey) has to be unique amoung all entities, so we have to generate it using the pair (type, id).
            deltaQuery: must return uniqueKey which will be used to match the changed entity (in db) with the Solr index.
                        nust return the database id to be used in the deltaImportQuery.
            deletedPkQuery: must return uniqueKey which will be used to remove document from Solr index.
         -->
        <entity name="Material" pk="uniqueKey"
            query="select concat('material', id ) as uniqueKey, id, licenseType, paid, 'material' as type from Material WHERE deleted = false"
            deltaImportQuery="select concat('material', id ) as uniqueKey, id, licenseType, paid, 'material' as type  from Material where id = '${dih.delta.id}'"
            deltaQuery="select concat('material', id ) as uniqueKey, id from Material where (CONVERT_TZ(added, @@session.time_zone, '+00:00') > '${dataimporter.last_index_time}' OR CONVERT_TZ(updated, @@session.time_zone, '+00:00') > '${dataimporter.last_index_time}') AND deleted = false"
            deletedPkQuery="select concat('material', id ) as uniqueKey from Material where (CONVERT_TZ(added, @@session.time_zone, '+00:00') > '${dataimporter.last_index_time}' OR CONVERT_TZ(updated, @@session.time_zone, '+00:00') > '${dataimporter.last_index_time}') AND deleted = true">
            <entity name="Material_Title" query="select title as title_id from Material_Title where material='${Material.id}'">
                <entity name="LanguageString" query="select textValue as title from LanguageString where id = '${Material_Title.title_id}'" />
            </entity>
            <entity name="Material_Description" query="select description as description_id from Material_Description where material='${Material.id}'">
                <entity name="LanguageString" query="select textValue as description from LanguageString where id = '${Material_Description.description_id}'" />
            </entity>
            <entity name="Material_Author" query="select author as author_id from Material_Author where material='${Material.id}'">
                <entity name="Author" query="select concat(name, ' ', surname) as fullname from Author where id = '${Material_Author.author_id}'">
                    <field column="fullname" name="author" />
                </entity>
            </entity>
            <entity name="Material_Tag" query="select tag as tag_id from Material_Tag where material='${Material.id}'">
                <entity name="Tag" query="select name as tag from Tag where id = '${Material_Tag.tag_id}'" />
            </entity>
            <entity name="Material_EducationalContext" query="select educationalContext as eC_id from Material_EducationalContext where material='${Material.id}'">
                <entity name="EducationalContext" query="select educationalContext as educational_context from EducationalContext where id = '${Material_EducationalContext.eC_id}'">
                    <entity name="Translation" query="select translation as educational_context from Translation where translationKey = '${EducationalContext.educational_context}'" />
                </entity>
            </entity>
            <entity name="Material_Subject" query="select subject as subject_id from Material_Subject where material='${Material.id}'">
                <entity name="Subject" query="select name as subject from Subject where id = '${Material_Subject.subject_id}'" />  
            </entity>
            <entity name="Material_ResourceType" query="select resourceType as resourceType_id from Material_ResourceType where material='${Material.id}'">
                <entity name="ResourceType" query="select resourceType as resource_type from ResourceType where id = '${Material_ResourceType.resourceType_id}'" />  
            </entity>
            <entity name="LicenseType" query="select name as license_type from LicenseType where id='${Material.licenseType}'" />
        </entity>
        <entity name="Portfolio" pk="uniqueKey"
            query="select concat('portfolio', id ) as uniqueKey, id, title, summary, educationalContext as eC_id, 'portfolio' as type from Portfolio">
            <entity name="EducationalContext" query="select educationalContext as educational_context from EducationalContext where id = '${Portfolio.eC_id}'">
                <entity name="Translation" query="select translation as educational_context from Translation where translationKey = '${EducationalContext.educational_context}'" />
            </entity>
            <entity name="Portfolio_Tag" query="select tag as tag_id from Portfolio_Tag where portfolio='${Portfolio.id}'">
                <entity name="Tag" query="select name as tag from Tag where id = '${Portfolio_Tag.tag_id}'" />
            </entity>
            <entity name="Chapter" query="select title as chapterTitle, textValue as chapterText from Chapter where portfolio = '${Portfolio.id}' or parentChapter in (select id from Chapter where portfolio = '${Portfolio.id}')">
            </entity>
        </entity>
    </document>
</dataConfig>